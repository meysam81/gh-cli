name: update-version

on:
  workflow_dispatch:
  schedule:
    - cron:  '0 0 * * *' # Midnight - every night

jobs:
  deploy:
    runs-on: ubuntu-latest

    name: Update GITHUB_CLI_VERSION

    steps:
      - name: Checkout code
        uses: actions/checkout@v2.3.4
        with:
          ref: ${{ github.head_ref }}

      - name: Get next gh version
        run: |
          current_version="$(grep -Eo "ENV GITHUB_CLI_VERSION .+" debian/Dockerfile | cut -d' ' -f3)"
          echo "$current_version"
          latest_versions="$(curl -sL https://api.github.com/repos/cli/cli/releases | jq -r '.[].tag_name' | tr '\n' ' ')"
          echo "$latest_versions"
          next_version="$(echo "$latest_versions" | grep -Eo "(.*?) v$current_version( |$)" | awk '{print $(NF-1)}' | cut -c2-)"
          echo "$next_version"
          echo "gh_version=${next_version}" >> $GITHUB_ENV

      - name: Cancel if no new version
        if: ${{ env.gh_version == '' }}
        uses: andymckay/cancel-action@0.2

      - name: Update GITHUB_CLI_VERSION
        run: |
          echo "${{ env.gh_version }}" | grep -Pq "^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$"
          find . -name Dockerfile -print0 | xargs -0 sed -i -E "s/^(ENV GITHUB_CLI_VERSION\s*).*$/\1${{ env.gh_version }}/g"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1.9.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker Image
        uses: docker/build-push-action@v2.4.0
        with:
          file: ./debian/Dockerfile

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4.11.0
        id: "commit"
        with:
          commit_message: "Update GITHUB_CLI_VERSION to ${{ env.gh_version }}"
          commit_user_name: actions-user
          commit_user_email: actions@github.com
          commit_author: GitHub Actions <actions@github.com>

      - name: Push Docker Image
        if: steps.commit.outputs.changes_detected == 'true'
        uses: docker/build-push-action@v2.4.0
        with:
          push: true
          file: ./debian/Dockerfile
          tags: |
            ghcr.io/${{ github.repository }}:${{ env.gh_version }}
            ghcr.io/${{ github.repository }}:latest
